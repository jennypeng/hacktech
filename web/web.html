<style type="text/css">
	body {
		padding: 2em;
	}
	.form-control.flasher {
		background-color: white;
		-webkit-transition: background-color 0.9s linear;
			    transition: background-color 0.9s linear;
	}
	.form-control.flasher.flash {
		background-color: #FFE68F;
		-webkit-transition: background-color 0s linear;
			    transition: background-color 0s linear;
	}
</style>
<link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
<script type="text/javascript" src='https://cdn.firebase.com/js/client/1.0.2/firebase.js'></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!-- <script type="text/javascript" src='https://cdn.firebase.com/js/simple-login/1.2.1/firebase-simple-login.js'></script> -->
<script type="text/javascript">

function httpGet(theUrl){
    var xmlHttp = null;

    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false );
    xmlHttp.send( null );
    return xmlHttp.responseText;
}

function search(query){
    response = httpGet('http://ws.spotify.com/search/1/track.json?q='+query);
    res = JSON.parse(response)
    if(res.tracks[0]){
        return res.tracks[0].href;
    }
}

LiveDJ = (function(){
	var self = {};

	self.roomName = undefined;
	self.currentSongData = undefined;
	self.lastTrackURL = undefined;

	self.updateInputIfNecessary = function(selector, value) {
		$el = $(selector);
		$el.select();
		if ($el.val() != value)
			$el.val(value);
		$el.addClass('flash');
		setTimeout(function() {
			$el.removeClass('flash');
		}, 0);
	}

	self.changeRoom = function(roomName) {
		roomName = roomName.toLowerCase();
		self.currentSongData = new Firebase('https://livedj01.firebaseio.com/rooms/'+roomName+'/song');
		// $('#roomName').text(roomName);
		self.currentSongData.on("value", self.onDataChange);

		self.updateInputIfNecessary('#roominput', roomName);
		console.log("room changed to " + roomName);
	}

	self.onDataChange = function(data) {
		if (!data) return;
		self.lastTrackURL = data.val();
		self.updateInputIfNecessary('#songinput', self.lastTrackURL);
		console.log("Track URL updated: ", self.lastTrackURL);
		// var track = models.Track.fromURI( self.lastTrackURL );
		// models.player.playTrack(track);
	}

	self.submitSong = function() {
		self.currentSongData.set($('#songinput').val());
	}

	self.submitRoom = function() {
		self.changeRoom($('#roominput').val());
	}

	self.init = function() {
		self.changeRoom('welcometohacktech');
		$('#songinput').select();
	}

	return self;
})();

$(document).ready(LiveDJ.init);
</script>

<form role="form">
  <div class="form-group">
    <label for="input">Room ID</label>
    <input type="text" class="form-control flasher" id="roominput" placeholder="room:&hellip;">
  </div>
  <button type="submit" id="submitRoom" onclick="LiveDJ.submitRoom(); return false;" class="btn btn-default">Change Room</button>
</form>

<form role="form">
  <div class="form-group">
    <label for="input">Song Spotify URL</label>
    <input type="text" class="form-control flasher" id="songinput" placeholder="spotify:track:&hellip;">
  </div>
  <button type="submit" id="submitSong" onclick="LiveDJ.submitSong(); return false;" class="btn btn-default">Submit Song</button>
</form>